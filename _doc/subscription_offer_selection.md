## Price offer selection algorithm

[Paywall](./paywall.md)的数据结构中可以看到，每个产品下面有多个价格，每个价格下面有多个折扣价格。折扣分为四个类别：

* `promotion`: 适用于所有会员的促销活动
* `retention`: 适用于会员有效期内的会员
* `win_back`: 适用于曾经购买了但当前时间已经过期的会员
* `introductory`: 仅用于还不是会员的账号

其中，`introductory`, `retention`, `win_back` 三类互斥，一个用户在某一时间只会处于某一状态下。 

步骤1：根据Membership中包含的数据推测该用户属于哪些折扣类别（可能包含多个）：

* 当Membership中的`tier`为`null`时，用户可能未登录，或者没有会员记录，则`promotion`和`introductory`均适用
* 如果`tier`不是`null`，则检测是否已经过期，过期的标准是`expireDate`在今天之前，并且`autoRenew`是`false`。如果已经过期，则属于`promotion` 或者`win_back`。
* 如果未过期，则属于`promotion`或者`win_back`。

步骤2：筛选出一个价格下的有效折扣。如果一个折扣未设置起止时间，则为永久性折扣，始终有效；如果有起止时间，则当前时刻处于起止时间中的折扣才有效。有效折扣可能会有多个。

步骤3：以步骤1中的折扣类别，进一步筛选步骤2中的结果，留下所有符合步骤1类别的折扣。

步骤4：按照折扣中的`priceOff`字段，从大到小排序，排在第一位是用户可以获得的最高折扣，这就是一个用户在该价格下适用的优惠。

因此，设置折扣时，同一种类别实际上可以设置多个折扣。如标准年度版为例，存在一个`retention`类别的永久性折扣，减去80元。如果我们再设置一个同类别的折扣，减去的折扣设为100元，起止时间设为 2021-11-10T16:00:00Z 到
2021-11-11T16:00:00Z（即东八区11月11日当天全天），对于一个未过期会员，减80和减100两个折扣都适用，由于我们只取折扣价最高者，所以会使用减100的折扣。

假设，我们在当天又设置了一个promotion的折扣价，减去99元，该会员依然会看到减100的价格，而不是减99的价格。
