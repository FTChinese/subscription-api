# Subscription API

API for subscription service

## Issues

There's a problem with the wxpay sdk used here `github.com/objcoding/wxpay`. The `XmlToMap()` function this package provides does not take into account of indented or formatted XML. It requires that there's not space between each XML tag. If there are spaces and tabs, it cannot get the correct value.

## How to run

You need to put those files in the root directory of this project:

* `.env` Copy the `.env.example` file and rename it to `.env`
* `alipay_public_key.pem`
* `ftc_private_key.pem`

When deploying you need to put files exactly as follows:
```
go
 |----bin/
 |      |--- subscription-api
 |----.env
 |----alipay_public_key.pem
 |----ftc_private_key.pem
```

`cd` into directory `go` before run it since the program read those configuration files from the current working directory.

## Pitfalls

Wechat's APP ID, MCH ID must match, which means APP ID must be in your MCH ID's authorized list; otherwise you could never call wechat on you app.

32 char key is the one you entered, not generated by wechat.

## Renewal Policy

A subscribed user is only allowd to renew the next billing cycle. If the difference between current date and the expiration date is less than the billing cycle he is trying to subscribe, the user is allowed to renew subscription; otherwise, deny the request.

Example:

A user is subscribe to a yearly membership from 2018-01-01 to 2019-01-01. Today is 2018-07-01 and He is trying to extend one year more's subscription. The difference between toay (2018-07-01) to expiration date (2019-01-01) is less then a billing cycle (one year). He can renew subscription to 2020-01-01. After renewal, this user immediately tries to extend another billing cycle to 2021-01-01. This request will be denied since today (2018-07-01) to expiration date (2020-01-01) is greater than a yearly billing cycle.

The same priciple applies to monthly subscrition. A user could only buy two month consecutively at most.

## Endpoints

### Build version

    GET /__version

See the the current version and when it was built.

### Wxpay Unified Order

    POST /wxpay/unified-order/{tier}/{cycle}

Request server to create wxpay's unified order.

#### Input

`tier` must be one of `standard` or `premium`.

`cycle` must be one of `year` or `month`.

Request header must contain:
```
X-User-Id: user-uuid
X-Client-Type: <web|ios|android>
X-Client-Version: <major.minor.path>
```

If `X-Client-Type` is `web`, the request header must also contain
```
X-User-Agent: <forwarded user agent for web> 
X-User-Ip: <forwareded user ip>
```

#### Response

* `401 Unauthorized` if request header does not contain `X-User-Id`.

* `400 Bad Request`

If `tier` and `cycle` is not one of the values as specified above;

If subscription plan if not found;

If wechat server send back error;

* `403 Forbidden`

If this user is already a member and current date is not within the allowed renewal period.

```json
{
    "message": "Already a subscribed user and not within allowed renewal period.",
}
```
* `422 Unprocessable Entity`

if `return_code` in wechat's reponse is `FAIL`:
```json
{
    "message": "appid不存在 | 商户号mch_id与appid不匹配 | invalid spbill_create_ip | spbill_create_ip参数长度有误",
    "error": {
        "field": "return_code",
        "code": "fail"
    }
}
```

if `result_code` from wechat is `FAIL`:
```json
{
    "message": "系统异常，请用相同参数重新调用",
    "error": {
        "field": "result_code",
        "code": "SYSTEMERROR"
    }
}
```

* `500 Internal Server Error` for any server or database error.

* `200 OK`

All fields except `ftcOrderId` is required by https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=9_12&index=2.

`ftcOrderId` is added after all other fields are signed. Client can use it to query order status after payment.

```json
{
    "appid": "wx app id",
    "partnerid": "wx mch id",
    "prepayid": "wx created prepay id",
    "package": "Sign=WXPay",
    "noncestr": "string",
    "timestamp": "unix timestamp",
    "sign": "string",
    "ftcOrderId": "custom field"
}
```

### Wx Query Order

    GET /wxpay/query/{orderId}

#### Response

* `401 Unauthorized` if request header does not contain `X-User-Id`.

* `400 Bad Request` if orderId is empty;

* `404 Not Found` if the orderId is not found, or if this order's `appid` and `mchid` is not us.

* `422 Unprocessable Entity`

if wechat's `return_code` is `FAIL`:
```json
{
    "message": "签名失败",
    "error": {
        "field": "return_code",
        "code": "fail"
    }
}
```

if wechat's `result_code` is `FAIL`:
```json
{
    "message": "系统错误",
    "error": {
        "field": "result_code",
        "code": "fail"
    }
}
```

* `500 Internal Server Error` if errors occurred while contacting wechat server.

* `200 OK`
```json
{
    "openId": "string",
    "tradeType": "APP",
    "paymentState": "SUCCESS | REFUND | NOTPAY | CLOSED | REVOKED | USERPAYING | PAYERROR",
    "totalFee": "in cent",
    "transactionId": "string",
    "ftcOrderId": "string",
    "paidAt": "iso8601 time string",
    "paymentStateDesc": "支付失败，请重新下单支付"
}
```

### Create Alipay Order

    POST /alipay/app-order/{tier}/{cycle}

#### Input

Exactly the same as Wxpay Unified Order.

#### Response

* `401 Unauthorized` if request header does not contain `X-User-Id`.

* `400 Bad Request`

If `tier` and `cycle` is not one of the values as specified above;

If subscription plan if not found;

If sign request parameters failed;

* `403 Forbidden`

If this user is already a member and current date is not within the allowed renewal period.

```json
{
    "message": "Already a subscribed user and not within allowed renewal period.",
}
```

* `404 Not Found` if current does not exist.

* `200 OK`

```json
{
    "ftcOrderId": "string",
    "param": "string" // Pass this string to alipay sdk.
}
```

### Verify Ali App Pay Result

    POST /alipay/verify/app-pay

#### Input

In your app, when you called Zhifubao, if will show a popup window on top of your app. After you confirmed payment and the popup window goes away, you app will get a map:
```json
{
    "resultStatus":"9000", 
    "result":"", 
    "memo": ""
}
```

Note `result` is a string, not a map. Post the string directly to this endpoint:
```
{"alipay_trade_app_pay_response":{"code":"10000","msg":"Success","app_id":"","auth_app_id":"","charset":"utf-8","timestamp":"2018-10-28 16:49:31","out_trade_no":"FT0055301540716534","total_amount":"0.01","trade_no":"2018102822001439881007782559","seller_id":"2088521304936335"},"sign":"MHrLSKA3KUKxsN9Yuhnzqbj5jpnSQ8drar5nt3gQJ0OzSTmmaYvYhEPEf/Qf6T+3t4UAnWmbRRGuHqruDK2/AuH+xtmhElPFLXo9dnkduUe5c15/AKtW6V2SWs+TGmSi38Wb/3NgeINtlSSxGnLXsW3uzbnybEd0E/L4nyqaKZ+yF3GWsWAsLzgf/O9y5ntpc7st3Vu1I2icipp34N9a4UbnOML0/kPuLls09K6/w461AAXh2GE4+L103lp/M4QFd5Lghauod75VctKI/xro06jIEjRkojFOOry+dugqEDxUQX+3CHzqOojub6ozD5GTZUV0ynOZCQA4iX+oOZ52lw==","sign_type":"RSA2"}
```

You need to manually extract this JSON-string to get the value of `alipay_trade_app_pay_response` -- an extremely stupid design.

If you parse it into a map and then verify the pased data structure, you'll never pass -- JSON is unordered and order is important in digital signature.

#### Response

* `400 Bad Request` if parsing JSON failed.

* `404 Not Found` if the order is not found.

* `422 Unprocessable Entity`

if signature is not valid:
```json
{
    "message": "",
    "error": {
        "field": "sign",
        "code": "invalid"
    }
}
```

if signature is valid but not correct:
```json
{
    "message": "",
    "error": {
        "field": "sign",
        "code": "incorrect"
    }
}
```

if `app_id` is wrong:
```json
{
    "message": "",
    "error": {
        "field": "app_id",
        "code": "incorrect"
    }
}
```
if `total_amount` does not match the one recorded in database.
```json
{
    "message": "",
    "error": {
        "field": "total_amount",
        "code": "incorrect"
    }
}
```

* `200 OK`
```json
{
    "code": "",
    ""
}
```

## Server to Server Notification

### Wechat

Example wx notification data as described on https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=9_7&index=3

```json
{
    "cash_fee":1,
    "is_subscribe": "N",
    "mch_id": "1504993271",
    "time_end": "20181027175113",
    "total_fee":1,
    "bank_type": "CFT",
    "nonce_str":"1540633845456125000", 
    "result_code":"SUCCESS",
    "return_code":"SUCCESS",
    "transaction_id":"4200000190201810278529489604",
    "fee_type": "CNY",
    "out_trade_no":"FT0055501540633845",
    "sign":"8C4B3D90F2B989EAAC4B541329EF5F8B",
    "appid":"wxacddf1c20516eb69",
    "openid":"ob7fA0h69OO0sTLyQQpYc55iF_P0",
    "trade_type":"APP"
}
```

Order query response:
```json
{
    "return_msg":"OK",
    "total_fee":1,
    "fee_type":"CNY", 
    "transaction_id":"4200000192201810276298895392",
    "out_trade_no":"FT0059051540637408",
    "mch_id":"1504993271",
    "is_subscribe":"N",
    "trade_state_desc":"支付成功",
    "return_code":"SUCCESS",
    "openid":"ob7fA0h69OO0sTLyQQpYc55iF_P0",
    "trade_type":"APP",
    "bank_type":"CFT",
    "trade_state":"SUCCESS",
    "time_end":"20181027185023",
    "cash_fee":1,
    "appid":"wxacddf1c20516eb69",
    "nonce_str":"iP1joB3m1zqDAzUL",
    "sign":"2C5F0583127CE3D975DEC5EF2E4A8C45",
    "result_code":"SUCCESS",
    "attach":""
}

```
### Ali